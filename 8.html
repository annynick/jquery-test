<html><head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>waterfull-lazyload-ajax demo</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link href="" rel="stylesheet">
<style>
	html,body,ul,li,p,div{
		margin: 0;
		padding: 0;
		box-sizing: border-box;
	}
	ul,li{
		list-style: none;
	}

  .wrap{
  	width: 900px;
		margin: 0 auto;
  }

	.clearfix:after{
		content: '';
		display: block;
		clear: both;
	}
	#pic-ct{
		position: relative;
	}
	#pic-ct .item{
		position: absolute;
		padding: 0 0 10px 0;
		width: 280px;
		margin: 10px;
		border: 1px solid #DFDFDF;
		background: #FFF;
		opacity: 0;
		transition: all .8s;
	}
	#pic-ct .item img{
	    margin: 10px;
	    width: 260px;
	}
	#pic-ct .item .header{
		height: 25px;
	    margin: 0 12px;
	    border-bottom: 1px solid #DBDBDB;
	}
	#pic-ct .desp{
		font-size: 12px;
		line-height: 1.8;
	  margin: 10px 15px 0;
	  color: #777371;
	}
	#load{
		visibility: hidden;
		height: 20px;
	}
	.hide{
		display: none;
	}
</style>
</head>
<body>
	 <div class="wrap">
    <div class="ct-waterfall">
    	<ul id="pic-ct" class="clearfix" style="height: 2170px;">
    		<!--<li class="item">
    			<a href="#" class="link">
    				<img src="http://s.img.mix.sina.com.cn/auto/resize?img=http%3A%2F%2Fwww.sinaimg.cn%2Fdy%2Fslidenews%2F5_img%2F2016_09%2F453_75615_657883.jpg&size=250_0" alt="">
    			</a>
    			<h4 class="header">标题</h4>
    			<p class="desp">
    				当地时间2016年3月1日，在东部与亲俄武装作战中受伤的乌克兰士兵接受海豚治疗。
    			</p>
    		</li>-->

				<!-- 用于计算 item 宽度和列数，但不展示出来-->
				<li class="item hide"></li>
    	<li class="item" style="left: 0px; top: 0px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_94111.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170714/qzpw-fyiavtv5836680.jpg" alt=""></a> <h4 class="header">老照片上色展探险家南极之旅</h4><p class="desp"></p></li><li class="item" style="left: 300px; top: 0px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_94110.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170714/3YmH-fyiavtv5835292.jpg" alt=""></a> <h4 class="header">美网红早产河马与爸妈团聚</h4><p class="desp">美国俄亥俄州，一直受到网友们广泛关注的辛辛那提动植物园网红小河马Fiona首次与妈妈Bibi、爸爸Henry一家团聚，画面分外温馨。</p></li><li class="item" style="left: 600px; top: 0px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_94107.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170714/BA4F-fyiavtv5829625.jpg" alt=""></a> <h4 class="header">狮子扑倒落单水牛后遭群吓退</h4><p class="desp">两头狮子发现了这头落单的受伤水牛，对它们来说，这无疑是相当容易捕杀的猎物。</p></li><li class="item" style="left: 0px; top: 265px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93667.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170712/P3ev-fyhwret2577421.jpg" alt=""></a> <h4 class="header">美私人小岛设施齐备售价5400万</h4><p class="desp">美国缅因州的希望岛正在市场上出售，标价795万美元（约合人民币5400万元）。</p></li><li class="item" style="left: 600px; top: 307px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93666.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170712/jH-2-fyhwret2570779.jpg" alt=""></a> <h4 class="header">看国外人山人海：密恐症都犯了</h4><p class="desp">人山人海不是中国独有的现象，世界各地的震撼人海奇观景象也不逞多让，密集恐惧症的人慎入奥！</p></li><li class="item" style="left: 300px; top: 328px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93926.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170713/7PQ_-fyhwret3926086.jpg" alt=""></a> <h4 class="header">迄今最清晰木星大红斑</h4><p class="desp">目前，美国宇航局“朱诺号”探测器距离木星9000公里处，拍摄到迄今最清晰的木星大红斑结构。</p></li><li class="item" style="left: 0px; top: 572px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93924.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170713/C-7G-fyhwret3912408.jpg" alt=""></a> <h4 class="header">鳄鱼眼睛露出凶狠红光恐怖至极</h4><p class="desp">美国摄影师Larry Lynch在佛罗里达州米亚卡河州立公园捕捉到十分恐怖又珍贵的画面。</p></li><li class="item" style="left: 600px; top: 635px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93664.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170712/B6SA-fyhwret2564177.jpg" alt=""></a> <h4 class="header">墨西哥红膝狼蛛蜕皮的完整过程</h4><p class="desp">研究人员最新拍摄视频图像显示，一只墨西哥红膝狼蛛如何蜕去全部的皮肤。</p></li><li class="item" style="left: 300px; top: 656px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93923.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170713/K2rF-fyhwret3907945.jpg" alt=""></a> <h4 class="header">斗牛士被愤怒公牛顶伤</h4><p class="desp">近日在西班牙的奔牛节上，一名斗牛士不幸被抛到空中、并被一头愤怒的公牛顶伤。</p></li><li class="item" style="left: 0px; top: 879px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93421.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170711/bRJW-fyhweih2556083.jpg" alt=""></a> <h4 class="header">人类造出的那些动物机器人.图</h4><p class="desp">在现代机器人中，生物学常常被视为解决问题的方法，以帮助现代机器人更自然地活动，更好地与他们的世界互动。</p></li><li class="item" style="left: 600px; top: 942px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93421.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170711/bRJW-fyhweih2556083.jpg" alt=""></a> <h4 class="header">人类造出的那些动物机器人.图</h4><p class="desp">在现代机器人中，生物学常常被视为解决问题的方法，以帮助现代机器人更自然地活动，更好地与他们的世界互动。</p></li><li class="item" style="left: 300px; top: 963px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93420.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170711/0MZZ-fyhwret1228316.jpg" alt=""></a> <h4 class="header">奇特笄蛭涡虫:无猎物时吃自己</h4><p class="desp">马来西亚柔佛州首府柔佛巴鲁的男子丹尼士o霍(Danish Ho)和家人在徒步旅行途中发现了一条看似蛇的锤头状蠕虫，他们拍下视频，并上传社交平台。</p></li><li class="item" style="left: 0px; top: 1207px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93308.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170710/OltA-fyhwret0357021.jpg" alt=""></a> <h4 class="header">老鹰俯冲至渔船叼走渔民猎物</h4><p class="desp">一段视频为人展示了一只美丽的老鹰俯冲到渔船上叼走鲑鱼片的全过程，令人吃惊不已。</p></li><li class="item" style="left: 600px; top: 1270px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93418.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170711/AgKE-fyhwret1224673.jpg" alt=""></a> <h4 class="header">高温天北极熊热瘫趴冰块上消暑</h4><p class="desp">匈牙利布达佩斯，当地气温达到30℃，布达佩斯动物园一只北极熊趴在冰块上消暑。</p></li><li class="item" style="left: 300px; top: 1312px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93306.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170710/Hhuk-fyhwret0339947.jpg" alt=""></a> <h4 class="header">拟态蛛不结网专门捕食其他蜘蛛</h4><p class="desp">尽管属于结网蛛类，但拟态蛛科的物种并不会结网，而是演化出复杂的捕食策略，以其他结网蛛类为食。</p></li><li class="item" style="left: 0px; top: 1514px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93213.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170709/00Ha-fyhwres9524505.jpg" alt=""></a> <h4 class="header">蛇形机器人装腿变身“多脚怪”</h4><p class="desp">如今，蛇型机器人已经被部署在世界各地，如埃及吉萨金字塔、奥地利废旧电厂、美国匹兹堡的下水道。</p></li><li class="item" style="left: 600px; top: 1577px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93307.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170710/UOM2-fyhwret0348572.jpg" alt=""></a> <h4 class="header">世界最大飞机车间占地50个球场</h4><p class="desp">西雅图埃弗雷特的波音工厂建于1967年，是美国最大的喷气式商业飞机的生产地，组装车间是世界上最大的单体建筑。</p></li><li class="item" style="left: 300px; top: 1640px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93304.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170710/_eh6-fyhwret0331990.jpg" alt=""></a> <h4 class="header">搞笑的野生动物:卖萌喜感十足</h4><p class="desp">2017年野生动物喜剧摄影大赛入围作品已公布，各类野生动物爆笑登场。</p></li><li class="item" style="left: 0px; top: 1842px; opacity: 1;"> <a href="http://slide.tech.sina.com.cn/d/slide_5_453_93212.html/d/2" class="link"><img src="http://n.sinaimg.cn/tech/transform/20170709/jtA6-fyhwres9518807.jpg" alt=""></a> <h4 class="header">英国可爱红松鼠的四季生活</h4><p class="desp">摄影师在与红松鼠生活多年之后，拍摄了一组照片，让世人有机会进一步了解这个物种的神秘生活。</p></li></ul>
    	<div id="load">我是看不见的</div>
    </div>
	</div>


<script src="http://apps.bdimg.com/libs/jquery/1.9.1/jquery.min.js"></script>

<script>


//1. 获取数据
//2. 把数据变为 Dom，通过瀑布流的方式放到页面上
//3. 当滚动到底部的时候， --》 1

var curPage = 1
var perPageCount = 3
var colSumHeight = []
var nodeWidth = $('.item').outerWidth(true)
var colNum = parseInt($('#pic-ct').width()/nodeWidth)

for(var i = 0; i < colNum; i++){
	colSumHeight[i] = 0
    
}
// var isDataArrive = true

start()

function start(){

	getData(function(newsList){
		// isDataArrive = true
		$.each(newsList, function(idx, news){
			var $node = getNode(news)
			$node.find('img').load(function(){
				$('#pic-ct').append($node)
                console.log($node,'loading...')
				waterFallPlace($node)
			})
		})
	})
	// isDataArrive = false	
}


$(window).scroll(function(){
	// if(!isDataArrive) return
	
	if(isVisible($('#load'))){
		start()
	}
})


function getData(callback){
		$.ajax({
			url: 'http://platform.sina.com.cn/slide/album_tech',
			dataType: 'jsonp',   
			jsonp:"jsoncallback",
			data: {
				app_key: '1271687855',
				num: perPageCount,
				page: curPage
			}
		}).done(function(ret){
			if(ret && ret.status && ret.status.code === "0"){
				callback(ret.data);   //如果数据没问题，那么生成节点并摆放好位置
				curPage++
			}else{
				console.log('get error data');
			}
		});
}


function getNode(item){
	var tpl = ''
		tpl += '<li class="item">';
		tpl += ' <a href="'+ item.url +'" class="link"><img src="' + item.img_url + '" alt=""></a>';
		tpl += ' <h4 class="header">'+ item.short_name +'</h4>';
		tpl += '<p class="desp">'+item.short_intro+'</p>';
		tpl += '</li>';
	
	return $(tpl)
}

function waterFallPlace($node){

		var idx = 0,
			minSumHeight = colSumHeight[0];

		for(var i=0;i<colSumHeight.length; i++){
			if(colSumHeight[i] < minSumHeight){
				idx = i;
				minSumHeight = colSumHeight[i];
			}
		}

		$node.css({
			left: nodeWidth*idx,
			top: minSumHeight,
			opacity: 1
		});

		colSumHeight[idx] = $node.outerHeight(true) + colSumHeight[idx];
		$('#pic-ct').height(Math.max.apply(null,colSumHeight));

}

	function isVisible($el){
	  var scrollH = $(window).scrollTop(),
	  	  winH = $(window).height(),
	  	  top = $el.offset().top;

  	  if(top < winH + scrollH){
  	  	return true;
  	  }else{
  	  	return false;
  	  }
	}


/*



	var clock;
	$(window).on('scroll', function(){
    //用户鼠标滚轮滚动一次，有多次事件响应。下面的 setTimeout 主要是为性能考虑，只在最后一次事件响应的时候执行 checkshow
    if(clock){
      clearTimeout(clock);
    }
    clock = setTimeout(function(){
      checkShow();
    }, 100);
	});

  // 用户第一次打开页面，还未滚动窗口的时候需要执行一次 checkShow
	checkShow();

*/

	// function checkShow(){
	// 	if(isShow($('#load'))){
	// 		loadAndPlace();
	// 	}
	// }

	// function isShow($el){
	//   var scrollH = $(window).scrollTop(),
	//   	  winH = $(window).height(),
	//   	  top = $el.offset().top;

  	//   if(top < winH + scrollH){
  	//   	return true;
  	//   }else{
  	//   	return false;
  	//   }
	// }



// 获取数据，并且摆放位置

//   var curPage = 1,
// 	  perPageCount = 9;

// 	function loadAndPlace(){
// 		$.ajax({
// 			url: 'http://platform.sina.com.cn/slide/album_tech',
// 			dataType: 'jsonp',   //这里使用了新浪新闻的 jsonp 接口，大家可以直接看数据， 如： http://platform.sina.com.cn/slide/album_tech?jsoncallback=func&app_key=1271687855&num=3&page=4
// 			jsonp:"jsoncallback",
// 			data: {
// 				app_key: '1271687855',
// 				num: perPageCount,
// 				page: curPage
// 			}
// 		}).done(function(ret){
// 			if(ret && ret.status && ret.status.code === "0"){
// 				place(ret.data);   //如果数据没问题，那么生成节点并摆放好位置
// 				curPage++
// 			}else{
// 				console.log('get error data');
// 			}
// 		});
// 	}



// function place(nodeList){
// 	console.log(nodeList);
// 	$.each(nodeList, function(index,item){
// 		var $node = getNode(item)
// 		$node.find('img').load(function(){
// 			$('#pic-ct').append($node)
// 			waterFallPlace($node)
// 		})
// 	})

// 	/*

// 	var $nodes = renderData(nodeList);  //节点生成后添加到页面上

// 	var defereds = [];  //创建存储 defered 对象的数组
// 	$nodes.find('img').each(function(){
// 		var defer = $.Deferred();
// 		$(this).load(function(){
// 			defer.resolve();
// 		});   //当每个图片加载完成后，执行 resolve
// 		defereds.push(defer);
// 	});
// 	$.when.apply(null,defereds).done(function() { //当所有的图片都执行 resolve 后，即全部图片加载后，执行下面的内容
// 		console.log('new images all loaded ...');
// 		//当节点里的图片全部加载后再使用瀑布流计算，否则会因为图片未加载 item 高度计算错误导致瀑布流高度计算出问题
// 		waterFallPlace($nodes);
// 	});
// 	*/
// }



// // 瀑布流

// var colSumHeight = [],
// 		nodeWidth = $('.item').outerWidth(true),
// 		colNum = parseInt($('#pic-ct').width()/nodeWidth);

// for(var i=0; i<colNum; i++){
// 	colSumHeight.push(0)
// }

// function waterFallPlace($nodes){
// 	$nodes.each(function(){
// 		var $cur = $(this);
// 		//colSumHeight = [100, 250, 80, 200]

// 		var idx = 0,
// 			minSumHeight = colSumHeight[0];

// 		for(var i=0;i<colSumHeight.length; i++){
// 			if(colSumHeight[i] < minSumHeight){
// 				idx = i;
// 				minSumHeight = colSumHeight[i];
// 			}
// 		}

// 		$cur.css({
// 			left: nodeWidth*idx,
// 			top: minSumHeight,
// 			opacity: 1
// 		});

// 		colSumHeight[idx] = $cur.outerHeight(true) + colSumHeight[idx];
// 		$('#pic-ct').height(Math.max.apply(null,colSumHeight));
// 	});

// }



// function getNode(item){
// 	var tpl = ''
// 		tpl += '<li class="item">';
// 		tpl += ' <a href="'+ item.url +'" class="link"><img src="' + item.img_url + '" alt=""></a>';
// 		tpl += ' <h4 class="header">'+ item.short_name +'</h4>';
// 		tpl += '<p class="desp">'+item.short_intro+'</p>';
// 		tpl += '</li>';
	
// 	return $(tpl)
// }


// function renderData(items){
// 	var tpl = '',
// 		$nodes;
// 	for(var i = 0;i<items.length;i++){
// 		tpl += '<li class="item">';
// 		tpl += ' <a href="'+ items[i].url +'" class="link"><img src="' + items[i].img_url + '" alt=""></a>';
// 		tpl += ' <h4 class="header">'+ items[i].short_name +'</h4>';
// 		tpl += '<p class="desp">'+items[i].short_intro+'</p>';
// 		tpl += '</li>';
// 	}
// 	$nodes = $(tpl);
// 	$('#pic-ct').append($nodes);
// 	return $nodes;
// }


 </script>


</body>
</html>